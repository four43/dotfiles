services:
  # Context7 MCP Server (Documentation lookup)
  context7:
    image: node:22-alpine
    container_name: mcp-context7
    working_dir: /app
    init: true
    command: sh -c "npm install -g @upstash/context7-mcp@latest && context7-mcp --transport http --port 3000"
    restart: unless-stopped
    ports:
      - "11001:3000"
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "3000"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # Terraform MCP Server
  terraform:
    image: hashicorp/terraform-mcp-server:0.3.3
    container_name: mcp-terraform
    init: true
    command: /bin/terraform-mcp-server streamable-http --transport-host 0.0.0.0 --transport-port 8080
    restart: unless-stopped
    ports:
      - "11002:8080"
    networks:
      - mcp-network
    # No healthcheck â€” image has no shell or utilities (distroless), starts instantly

  # AWS Terraform MCP Server (needs Debian for Playwright support)
  terraform-aws:
    image: node:22-slim
    container_name: mcp-terraform-aws
    entrypoint: ["sh", "-c"]
    init: true
    command:
      - >-
        apt-get update &&
        apt-get install -y --no-install-recommends python3 python3-venv curl ca-certificates &&
        curl -LsSf https://astral.sh/uv/install.sh | sh &&
        export PATH="/root/.local/bin:$$PATH" &&
        npm install -g supergateway@latest &&
        uv tool install awslabs.terraform-mcp-server@latest &&
        uvx --from playwright playwright install --with-deps chromium &&
        exec supergateway
        --stdio "uvx awslabs.terraform-mcp-server@latest"
        --outputTransport streamableHttp
        --host 0.0.0.0
        --port 8000
        --stateful
        --sessionTimeout 300000
        --cors
        --healthEndpoint /healthz
    restart: unless-stopped
    ports:
      - "11003:8000"
    networks:
      - mcp-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 180s

  # AWS Diagram MCP Server
  aws-diagram:
    image: supercorp/supergateway:uvx
    container_name: mcp-aws-diagram
    entrypoint: ["sh", "-c"]
    init: true
    command:
      - >-
        apk add --no-cache graphviz &&
        exec supergateway
        --stdio "uvx awslabs.aws-diagram-mcp-server@latest"
        --outputTransport streamableHttp
        --host 0.0.0.0
        --port 8000
        --stateful
        --sessionTimeout 300000
        --cors
        --healthEndpoint /healthz
    restart: unless-stopped
    ports:
      - "11004:8000"
    networks:
      - mcp-network
    volumes:
      - /tmp/generated-diagrams:/tmp/generated-diagrams
    environment:
      - FASTMCP_LOG_LEVEL=INFO
      - AWS_DOCUMENTATION_PARTITION=aws
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # AWS Documentation MCP Server
  aws-documentation:
    image: supercorp/supergateway:uvx
    container_name: mcp-aws-documentation
    init: true
    command: >-
      --stdio "uvx awslabs.aws-documentation-mcp-server@latest"
      --outputTransport streamableHttp
      --host 0.0.0.0
      --port 8000
      --stateful
      --sessionTimeout 300000
      --cors
      --healthEndpoint /healthz
    restart: unless-stopped
    ports:
      - "11005:8000"
    networks:
      - mcp-network
    environment:
      - FASTMCP_LOG_LEVEL=INFO
      - AWS_DOCUMENTATION_PARTITION=aws
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8000/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

networks:
  mcp-network:
    name: mcp-network
    driver: bridge
